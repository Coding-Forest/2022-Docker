# <span id='top'>01 Containerise Python Application</span>

### Project 1 - Movie picker

[[🐳Dockerfile]](#Dockerfile)

### Project 2 - FastAPI app

[[Summary]](#Summary)
[[`venv`]](#venv)
[[Prepare Dependencies]](#Dependencies)  
[[🐳Dockerfile]](#Dockerfile-fastapi)
[[References]](#ref)

<br>

## <span id='Summary'>Summary</span>

[[Top]](#top)

1.  Run an `app` on local machine:

`fastapi-docker`  
ㅤ├──`app`  
ㅤ└──ㅤ└──`main.py` 👈 run this.

        ~/Desktop/fastapi-docker/app$ $ python main.py

2.  Run the dockerised container in a `venv`.

`fastapi-docker`  
ㅤ├──`app`  
ㅤ│ㅤㅤ└──`main.py` 🐳Image runs 👈this file.
ㅤ├──`venv`  
ㅤ└──`🐳Dockerfile`

        (venv) ~/Desktop/fastapi-docker$  dockr run -p 8000:8000 python-fastapi

            👉 CMD ["python", "./main.py"] 👈 this command in the image will run the application.

<br>

## <span id='Dockerfile'>🐳Dockerfile</span>

[[Top]](#top)

1. Build docker image.

- `-tag`, `-t`: Name and optionally a tag in the 'name:tag' format

        $ docker build -t python-imdb .

            Sending build context to Docker daemon  4.096kB
            Step 1/4 : FROM python:3.8
            3.8: Pulling from library/python
            0c6b8ff8c37e: Downloading [===============>                                   ]  17.17MB/54.92MB
            412caad352a3: Download complete
            e6d3e61f7a50: Downloading [======================================>            ]  8.383MB/10.87MB
            461bb1d8c517: Waiting
            404faa91ca52: Pulling fs layer
            dc2d66408fbd: Waiting

            Status: Downloaded newer image for python:3.8
            ---> d5453fc7b6f7
            Step 2/4 : ADD main.py .
            ---> 1da5ebcc8c1c
            Step 3/4 : RUN pip install requests beautifulsoup4
            ---> Running in 09a8c37f10ea
            Collecting requests
            Downloading requests-2.27.1-py2.py3-none-any.whl (63 kB)
            Collecting beautifulsoup4
            Downloading beautifulsoup4-4.10.0-py3-none-any.whl (97 kB)
            Collecting urllib3<1.27,>=1.21.1
            ...
            Removing intermediate container 09a8c37f10ea
            ---> ac64fb4af9e3
            Step 4/4 : CMD ["python", "./main.py"]
            ---> Running in c3ee77fbee93
            Removing intermediate container c3ee77fbee93
            ---> b0246147eb3a
            Successfully built b0246147eb3a
            Successfully tagged python-imdb:latest

### Troubleshoot

        $ docker build -t python-imdb .
            Sending build context to Docker daemon  4.096kB
            Error response from daemon: failed to parse Dockerfile: file with no instructions

https://stackoverflow.com/questions/58978320/error-response-from-daemon-failed-to-parse-dockerfile-file-with-no-instruction

<br>

2.  Run the built image.

        $ docker images

        REPOSITORY        TAG       IMAGE ID       CREATED         SIZE
        python-imdb       latest    b0246147eb3a   4 minutes ago   919MB   <------
        python            3.8       d5453fc7b6f7   36 hours ago    909MB
        hello-world       latest    feb5d9fea6a5   5 months ago    13.3kB
        docker/whalesay   latest    6b362a9f73eb   6 years ago     247MB

        $ docker ps -a

            CONTAINER ID   IMAGE             COMMAND                  CREATED          STATUS                      PORTS     NAMES
            00ab2b5dfcfa   python-imdb       "python ./main.py"       22 seconds ago   Exited (0) 19 seconds ago             elastic_heisenberg

See the random movie recommendations generated by `main.py`.

        $ docker run python-imdb

           The Pianist (2002), Rating: 8.5, Starring: Roman Polanski (dir.), Adrien Brody, Thomas Kretschmann

           Ben-Hur (1959), Rating: 8.1, Starring: William Wyler (dir.), Charlton Heston, Jack Hawkins

           Scarface (1983), Rating: 8.2, Starring: Brian De Palma (dir.), Al Pacino, Michelle Pfeiffer

           La passion de Jeanne d'Arc (1928), Rating: 8.1, Starring: Carl Theodor Dreyer (dir.), Maria Falconetti, Eugene Silvain

            Pather Panchali (1955), Rating: 8.2, Starring: Satyajit Ray (dir.), Kanu Bannerjee, Karuna Bannerjee

<br>

3.  Build another image with the full `main.py` script.

        $ docker build -t python-imdb-full .

            Sending build context to Docker daemon  4.096kB
            Step 1/4 : FROM python:3.8
            ---> d5453fc7b6f7
            Step 2/4 : ADD main.py .
            ---> caf247ee1649
            Step 3/4 : RUN pip install requests beautifulsoup4
            ---> Running in b3bcc996acd2
            Collecting requests
            Downloading requests-2.27.1-py2.py3-none-any.whl (63 kB)
            Collecting beautifulsoup4
            Downloading beautifulsoup4-4.10.0-py3-none-any.whl (97 kB)
            ...
            Removing intermediate container b3bcc996acd2
            ---> 9dd7933ad592
            Step 4/4 : CMD ["python", "./main.py"]
            ---> Running in 21a3acdedb0c
            Removing intermediate container 21a3acdedb0c
            ---> 8a1948ec98a6
            Successfully built 8a1948ec98a6
            Successfully tagged python-imdb-full:latest

Image has been built.

        $ docker images

            REPOSITORY         TAG       IMAGE ID       CREATED          SIZE
            python-imdb-full   latest    8a1948ec98a6   3 minutes ago    919MB  <----------
            python-imdb        latest    b0246147eb3a   15 minutes ago   919MB
            python             3.8       d5453fc7b6f7   37 hours ago     909MB
            hello-world        latest    feb5d9fea6a5   5 months ago     13.3kB
            docker/whalesay    latest    6b362a9f73eb   6 years ago      247MB

4.  Run it.

        $ docker run -t -i python-imdb-full

            Life of Brian (1979), Rating: 8.0, Starring: Terry Jones (dir.), Graham Chapman, John Cleese
            Do you want another movie (y/[n])? y

            Pulp Fiction (1994), Rating: 8.8, Starring: Quentin Tarantino (dir.), John Travolta, Uma Thurman
            Do you want another movie (y/[n])? y

            Witness for the Prosecution (1957), Rating: 8.4, Starring: Billy Wilder (dir.), Tyrone Power, Marlene Dietrich
            Do you want another movie (y/[n])? y

            Per qualche dollaro in più (1965), Rating: 8.2, Starring: Sergio Leone (dir.), Clint Eastwood, Lee Van Cleef
            Do you want another movie (y/[n])? y

            Trainspotting (1996), Rating: 8.1, Starring: Danny Boyle (dir.), Ewan McGregor, Ewen Bremner
            Do you want another movie (y/[n])? y

<br>

## <span id='venv'>`venv`</span>

[[Top]](#top)

1.  Create `venv`.

        $ python3 -m venv venv

2.  Activate `venv`.

        $ . venv/bin/activate

3.  Set up dependencies.

        (venv) ~/fastapi-docker$  pip install fastapi

           Successfully installed anyio-3.5.0 fastapi-0.74.1 idna-3.3 pydantic-1.9.0 sniffio-1.2.0 starlette-0.17.1 typing-extensions-4.1.1

        (venv) ~/fastapi-docker$ pip install uvicorn

            Successfully installed asgiref-3.5.0 click-8.0.4 h11-0.13.0 uvicorn-0.17.5

4.  (Optional) Test run the app.

If you run this step, this application will be running directly on your local machine. In the next steps, you can dockerise it and run it as a container on a docker image.

        $ python main.py

            INFO:     Started server process [138173]
            INFO:     Waiting for application startup.
            INFO:     Application startup complete.
            INFO:     Uvicorn👈 running on http://127.0.0.1:8000 (Press CTRL+C to quit)
            INFO:     127.0.0.1:57764 - "GET / HTTP/1.1" 200 OK
            INFO:     127.0.0.1:57764 - "GET /favicon.ico HTTP/1.1" 404 Not Found
            INFO:     127.0.0.1:57766 - "GET /items/5 HTTP/1.1" 200 OK
            INFO:     127.0.0.1:57766 - "GET /items/4 HTTP/1.1" 200 OK
            INFO:     127.0.0.1:57766 - "GET /items/3 HTTP/1.1" 200 OK
            ^CINFO:     Shutting down
            INFO:     Waiting for application shutdown.
            INFO:     Application shutdown complete.
            INFO:     Finished server process [138173]

<br>

## <span id='Dependencies'>Prepare Dependencies</span>

[[Top]](#top)

`fastapi-docker`  
ㅤ├──`app`  
ㅤ│ㅤㅤ└──`main.py`  
ㅤ├──`venv`  
ㅤ└──`requirements.txt` 👈 `pip freeze` creates this.

        $ pip freeze > requirements.txt

            requirements.txt

                anyio==3.5.0
                asgiref==3.5.0
                click==8.0.4
                fastapi==0.74.1   👈 The dependences we installed.
                h11==0.13.0
                idna==3.3
                pydantic==1.9.0
                sniffio==1.2.0
                starlette==0.17.1
                typing-extensions==4.1.1
                uvicorn==0.17.5    👈

<br>

## <span id='Dockerfile-fastapi'>🐳Dockerfile</span>

[[Top]](#top)

`fastapi-docker`  
ㅤ├──`🐳Dockerfile` 👈 craete & write this.  
ㅤ├──`app`  
ㅤ│ㅤㅤ└──`main.py`  
ㅤ├──`venv`  
ㅤ└──`requirements.txt`

        🐳Dockerfile

            FROM python:3.8

            # Automatically goes to this directory.
            WORKDIR /fastapi-app

            # Copy requirements into WORKDIR above.
            COPY requirements.txt .

            # Install dependencies.
            RUN pip install -r requirements.txt

            # Copy everything in /app in the local machien into the docker container.
            COPY ./app ./app

            CMD ["python", "./app/main.py"]

- `RUN pip install -r requirements.txt`

_Above statement looks for a python package named requirements.txt. No such package exists. Your intention is that pip install opens the txt and reads the packages from there. The -r allows pip install to open requirements.txt and install the packages inside of it instead._ (OlavRG, StackOverFlow)

<br>

## <span id=''>Build 🐳Docker image</span>

[[Top]](#top)

1.  Build docker image.

        (venv) $ docker build -t python-fastapi .

            Sending build context to Docker daemon   57.1MB
            Step 1/6 : FROM python:3.8
            ---> d5453fc7b6f7
            Step 2/6 : WORKDIR /fastapi-app
            ---> Running in a57fd1109bb4
            Removing intermediate container a57fd1109bb4
            ---> 063e1a1174b7
            Step 3/6 : COPY requirements.txt .
            ---> 816daef661bb

        👀See the required dependencies are being install in this step.
            Step 4/6 : RUN pip install -r requirements.txt 👈
            ---> Running in 14a3956b1b3d
            Collecting anyio==3.5.0
            Downloading anyio-3.5.0-py3-none-any.whl (79 kB)
            Collecting asgiref==3.5.0
            Downloading asgiref-3.5.0-py3-none-any.whl (22 kB)
            Collecting click==8.0.4
            Downloading click-8.0.4-py3-none-any.whl (97 kB)
            Collecting fastapi==0.74.1
            Downloading fastapi-0.74.1-py3-none-any.whl (53 kB)
            Collecting h11==0.13.0
            Downloading h11-0.13.0-py3-none-any.whl (58 kB)
            Collecting idna==3.3
            Downloading idna-3.3-py3-none-any.whl (61 kB)
            Collecting pydantic==1.9.0
            Downloading pydantic-1.9.0-cp38-cp38-manylinux_2_17_x86_64.manylinux2014_x86_64.whl (12.6 MB)
            Collecting sniffio==1.2.0
            Downloading sniffio-1.2.0-py3-none-any.whl (10 kB)
            Collecting starlette==0.17.1
            Downloading starlette-0.17.1-py3-none-any.whl (58 kB)
            Collecting typing-extensions==4.1.1
            Downloading typing_extensions-4.1.1-py3-none-any.whl (26 kB)
            Collecting uvicorn==0.17.5
            Downloading uvicorn-0.17.5-py3-none-any.whl (53 kB)
            Installing collected packages: sniffio, idna, typing-extensions, anyio, starlette, pydantic, h11, click, asgiref, uvicorn, fastapi
            Successfully installed anyio-3.5.0 asgiref-3.5.0 click-8.0.4 fastapi-0.74.1 h11-0.13.0 idna-3.3 pydantic-1.9.0 sniffio-1.2.0 starlette-0.17.1 typing-extensions-4.1.1 uvicorn-0.17.5

            Removing intermediate container 14a3956b1b3d
            ---> 5503b46aa408
            Step 5/6 : COPY ./app ./app
            ---> cc598baa18da
            Step 6/6 : CMD ["python", "./app/main.py"]
            ---> Running in 8904f175baf0
            Removing intermediate container 8904f175baf0
            ---> 0b2423e5be23
            Successfully built 0b2423e5be23
            Successfully tagged python-fastapi:latest

<br>

2. Layered architecture in action

I realise I did something wrong. I fix the code, and build it again.  
Thanks to the layered architecture, it's quicker to build the image this time.

        (venv) $ docker build -t python-fastapi .

            Sending build context to Docker daemon   57.1MB
            Step 1/6 : FROM python:3.8
            ---> d5453fc7b6f7
            Step 2/6 : WORKDIR /fastapi-app
            ---> Using cache
            ---> 063e1a1174b7
            Step 3/6 : COPY requirements.txt .
            ---> Using cache
            ---> 816daef661bb
            Step 4/6 : RUN pip install -r requirements.txt
            ---> Using cache
            ---> 5503b46aa408
            Step 5/6 : COPY ./app ./app
            ---> ddec7b790b31
            Step 6/6 : CMD ["python", "./app/main.py"]
            ---> Running in 91c2837dae10
            Removing intermediate container 91c2837dae10
            ---> fe7bdfa429dd
            Successfully built fe7bdfa429dd
            Successfully tagged python-fastapi:latest

<br>

## <span id=''>Run 🐳Docker image</span>

[[Top]](#top)

1.  Run it.

        (venv) $ docker run python-fastapi

        (venv) $ docker images

            REPOSITORY         TAG       IMAGE ID       CREATED             SIZE
            python-fastapi     latest    fe7bdfa429dd   5 seconds ago       978MB  👈 Newer version rebuilt on the existing layers.
            <none>             <none>    0b2423e5be23   3 minutes ago       978MB  👈 Original version
            python-imdb-full   latest    479ce28a62a3   About an hour ago   919MB
            python             3.8       d5453fc7b6f7   38 hours ago        909MB
            hello-world        latest    feb5d9fea6a5   5 months ago        13.3kB
            docker/whalesay    latest    6b362a9f73eb   6 years ago         247MB

2.  The same application is now running on the container.

        (venv) $ docker run -p 8000:8000 python-fastapi
        INFO:     Started server process [1]
        INFO:     Waiting for application startup.
        INFO:     Application startup complete.
        INFO:     Uvicorn running on http://0.0.0.0:8000 (Press CTRL+C to quit)
        INFO:     172.17.0.1:38174 - "GET / HTTP/1.1" 200 OK
        INFO:     172.17.0.1:38174 - "GET /favicon.ico HTTP/1.1" 404 Not Found
        INFO:     172.17.0.1:38176 - "GET /items/5 HTTP/1.1" 200 OK
        INFO:     172.17.0.1:38176 - "GET /items/100 HTTP/1.1" 200 OK
        ^CINFO:     Shutting down
        INFO:     Waiting for application shutdown.
        INFO:     Application shutdown complete.
        INFO:     Finished server process [1]

<br>

### <span id='ref'>References</span>

[[Top]](#top)

- StackOverFlow https://stackoverflow.com/questions/38066631/what-does-r-do-in-pip-install-r-requirements-txt#:~:text=The%20%2Dr%20allows%20pip%20install,packages%20inside%20of%20it%20instead.
